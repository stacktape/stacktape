resources:
  apiGateway:
    type: http-api-gateway
    properties:
      cors:
        enabled: true

  imagesBucket:
    type: bucket
    properties:
      cors:
        enabled: true

  processImage:
    type: function
    properties:
      packaging:
        type: stacktape-lambda-buildpack
        properties:
          entryfilePath: ./src/process-image.ts
      memory: 1024
      timeout: 60
      connectTo:
        - imagesBucket
      events:
        - type: s3
          properties:
            bucketArn: $ResourceParam('imagesBucket', 'arn')
            s3EventType: "s3:ObjectCreated:*"
            filterRule:
              prefix: uploads/

  api:
    type: function
    properties:
      packaging:
        type: stacktape-lambda-buildpack
        properties:
          entryfilePath: ./src/index.ts
      memory: 512
      connectTo:
        - imagesBucket
      events:
        - type: http-api-gateway
          properties:
            httpApiGatewayName: apiGateway
            path: /
            method: '*'
        - type: http-api-gateway
          properties:
            httpApiGatewayName: apiGateway
            path: /{proxy+}
            method: '*'
